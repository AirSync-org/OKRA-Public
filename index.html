<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OKRA ダウンロード</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.6; }
    .card { max-width: 760px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    button,a.btn { appearance: none; border: 1px solid #111; background: #111; color: #fff; padding: 12px 14px; border-radius: 10px; cursor: pointer; text-decoration: none; display:inline-block;}
    button.secondary,a.secondary { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: #666; font-size: 14px; }
    pre { background:#f6f8fa; padding:12px; border-radius:10px; overflow:auto; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px; margin-left: 8px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>OKRA ダウンロード</h1>
    <div id="status" class="muted">最新バージョンを確認中…</div>

    <p>
      <strong>最新バージョン:</strong>
      <span id="version">-</span>
      <span id="published" class="badge" style="display:none;"></span>
    </p>

    <div class="row">
      <a id="btnWin" class="btn" href="#" role="button" aria-disabled="true">Windows をダウンロード</a>
      <a id="btnMacArm" class="btn secondary" href="#" role="button" aria-disabled="true">Mac(Apple) をダウンロード</a>
      <a id="btnMacX64" class="btn secondary" href="#" role="button" aria-disabled="true">Mac(Intel) をダウンロード</a>
    </div>

    <p class="muted" style="margin-top:12px;">
      ※ ダウンロードは OKRA の公式配布ページから開始されます（配布元は GitHub Releases を利用）。
    </p>

    <details style="margin-top:14px;">
      <summary>リリースノート（最新）</summary>
      <div id="notes" class="muted" style="white-space:pre-wrap; margin-top:10px;"></div>
    </details>

    <details style="margin-top:14px;">
      <summary>検出された環境に合わせて自動でおすすめを強調</summary>
      <div id="env" class="muted" style="margin-top:10px;"></div>
    </details>

    <details style="margin-top:14px;">
      <summary>トラブルシュート</summary>
      <div class="muted" style="margin-top:10px;">
        GitHub API は匿名アクセスだとレート制限があります。表示できない場合は時間をおいて再読み込みしてください。<br/>
        社内ネットワーク等で api.github.com がブロックされている場合は、後述の「中継API（推奨）」方式にしてください。
      </div>
    </details>
  </div>

  <script>
    // ===== 設定 =====
    const OWNER = "AirSync-org";
    const REPO  = "OKRA-Public";
    const API_LATEST = `https://api.github.com/repos/${OWNER}/${REPO}/releases/latest`;

    // 探したいファイル名パターン（最新リリース assets から探す）
    const ASSET_PATTERNS = {
      windows: /OKRA-.*-setup\.exe$/i,
      mac_arm: /OKRA-.*-arm64\.dmg$/i,
      mac_x64: /OKRA-.*-x64\.dmg$/i,
    };

    // ===== UI参照 =====
    const $status    = document.getElementById("status");
    const $version   = document.getElementById("version");
    const $published = document.getElementById("published");
    const $notes     = document.getElementById("notes");
    const $env       = document.getElementById("env");

    const $btnWin    = document.getElementById("btnWin");
    const $btnMacArm = document.getElementById("btnMacArm");
    const $btnMacX64 = document.getElementById("btnMacX64");

    function setBtn(anchorEl, url) {
      if (!url) {
        anchorEl.setAttribute("aria-disabled", "true");
        anchorEl.href = "#";
        anchorEl.style.pointerEvents = "none";
        anchorEl.style.opacity = "0.5";
        return;
      }
      anchorEl.setAttribute("aria-disabled", "false");
      anchorEl.href = url;
      anchorEl.style.pointerEvents = "auto";
      anchorEl.style.opacity = "1";
      // クリック時に直接遷移（ダウンロード開始）
      anchorEl.addEventListener("click", (e) => {
        e.preventDefault();
        window.location.assign(url);
      }, { once: true });
    }

    function detectPlatform() {
      // できればUA-CH優先
      const ua = navigator.userAgent || "";
      const platform = navigator.platform || "";
      const isMac = /Mac/.test(platform) || /Mac OS X/.test(ua);
      const isWin = /Win/.test(platform) || /Windows/.test(ua);

      // Apple Silicon 判定はブラウザ依存で難しいので複数ヒューリスティック
      // Safari/Chromeの一部では "MacIntel" でも arm64 の場合がある（Rosettaなど）
      const uaData = navigator.userAgentData;
      const archHints = [
        (uaData && uaData.platform) ? uaData.platform : "",
        (uaData && uaData.architecture) ? uaData.architecture : "",
        ua,
      ].join(" ");

      const isArm = /arm|aarch64|apple\s?silicon/i.test(archHints);

      return { isMac, isWin, isArm, ua, platform };
    }

    function highlightRecommended(env) {
      // いったん全て通常に戻す
      [$btnWin, $btnMacArm, $btnMacX64].forEach(a => {
        a.classList.remove("btn");
        a.classList.remove("secondary");
        a.classList.add("secondary");
      });
      // おすすめを濃くする（btnクラス）
      if (env.isWin) {
        $btnWin.classList.remove("secondary");
        $btnWin.classList.add("btn");
      } else if (env.isMac) {
        if (env.isArm) {
          $btnMacArm.classList.remove("secondary");
          $btnMacArm.classList.add("btn");
        } else {
          $btnMacX64.classList.remove("secondary");
          $btnMacX64.classList.add("btn");
        }
      }
    }

    function findAssetUrl(assets, pattern) {
      const found = assets.find(a => pattern.test(a.name));
      return found ? found.browser_download_url : null;
    }

    async function main() {
      const env = detectPlatform();
      $env.textContent = `platform: ${env.platform} / UA: ${env.ua}`;
      highlightRecommended(env);

      try {
        // キャッシュ効かせたい場合は no-store 外してOK
        const res = await fetch(API_LATEST, {
          headers: {
            "Accept": "application/vnd.github+json",
          },
          cache: "no-store",
        });

        if (!res.ok) {
          throw new Error(`GitHub API error: ${res.status} ${res.statusText}`);
        }

        const release = await res.json();
        const assets = Array.isArray(release.assets) ? release.assets : [];

        const ver = release.tag_name || release.name || "-";
        $version.textContent = ver;

        if (release.published_at) {
          const dt = new Date(release.published_at);
          $published.style.display = "inline-block";
          $published.textContent = `公開: ${dt.toLocaleString("ja-JP")}`;
        }

        $notes.textContent = release.body || "(リリースノートなし)";

        const urlWin    = findAssetUrl(assets, ASSET_PATTERNS.windows);
        const urlMacArm = findAssetUrl(assets, ASSET_PATTERNS.mac_arm);
        const urlMacX64 = findAssetUrl(assets, ASSET_PATTERNS.mac_x64);

        setBtn($btnWin, urlWin);
        setBtn($btnMacArm, urlMacArm);
        setBtn($btnMacX64, urlMacX64);

        const missing = [];
        if (!urlWin) missing.push("Windows");
        if (!urlMacArm) missing.push("Mac(Apple)");
        if (!urlMacX64) missing.push("Mac(Intel)");

        if (missing.length) {
          $status.textContent = `最新リリースは取得できましたが、次の資産が見つかりません: ${missing.join(", ")}（assets名の命名規則を確認してください）`;
        } else {
          $status.textContent = "最新バージョンのダウンロード準備ができました。";
        }
      } catch (err) {
        console.error(err);
        $status.textContent = "最新情報の取得に失敗しました。ネットワーク制限やGitHub API制限の可能性があります。";
        // ボタンを無効化
        setBtn($btnWin, null);
        setBtn($btnMacArm, null);
        setBtn($btnMacX64, null);
      }
    }

    main();
  </script>
</body>
</html>